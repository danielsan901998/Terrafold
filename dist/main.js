function F(e){let s=1;if(e.ctrlKey)s*=5;if(e.shiftKey)s*=10;return s}function Ae(e){return Math.floor(e*10)/10}function Ie(e){return Math.floor(e*100)/100}function Te(e){return Number(e.toPrecision(2))}function B(e){return Number(e.toPrecision(3))}function H(e,s,r,i,n){return K(e,s,r,i)<n}function K(e,s,r,i){return Math.sqrt(Math.pow(Math.abs(e-r),2)+Math.pow(Math.abs(s-i),2))}function g(e,s){let r=1;if(e<0)r=-1,e*=-1;if(e>=1e4)return(r===1?"+":"-")+Re(e,3);else return(r===1?"+":"-")+ve(e,s)}function o(e,s){if(e>=1e4)return Re(e,3);else return ve(e,s)}function ve(e,s){if(Number.isInteger(e))return e.toString();let r=3;if(s!==void 0)r=s;return e.toFixed(r-1).replace(ye,"$1")}var Ne=[{value:1000000000000000000000000000000000000000000000000000000000000000,symbol:"V"},{value:1000000000000000000000000000000000000000000000000000000000000,symbol:"Nd"},{value:1000000000000000000000000000000000000000000000000000000000,symbol:"Od"},{value:1000000000000000000000000000000000000000000000000000000,symbol:"Sd"},{value:1000000000000000000000000000000000000000000000000000,symbol:"sd"},{value:1000000000000000000000000000000000000000000000000,symbol:"Qd"},{value:1000000000000000000000000000000000000000000000,symbol:"qd"},{value:1000000000000000000000000000000000000000000,symbol:"Td"},{value:1000000000000000000000000000000000000000,symbol:"Dd"},{value:1000000000000000000000000000000000000,symbol:"Ud"},{value:1000000000000000000000000000000000,symbol:"Dc"},{value:1000000000000000000000000000000,symbol:"N"},{value:1000000000000000000000000000,symbol:"O"},{value:1000000000000000000000000,symbol:"Sp"},{value:1000000000000000000000,symbol:"Sx"},{value:1000000000000000000,symbol:"Qi"},{value:1000000000000000,symbol:"Qa"},{value:1000000000000,symbol:"T"},{value:1e9,symbol:"B"},{value:1e6,symbol:"M"},{value:1000,symbol:"K"}],ye=/\.0+$|(\.[0-9]*[1-9])0+$/,G=new Map;function Re(e,s){let r=e+"|"+s,i=G.get(r);if(i!==void 0)return i;let n,d=!1;for(let h=0;h<Ne.length;h++){let m=Ne[h];if(m&&e>=m.value/1.000501){n=(e/m.value).toPrecision(s).replace(ye,"$1")+m.symbol,d=!0;break}}if(!d)n=e.toPrecision(s).replace(ye,"$1");if(G.size>1000){let h=G.keys().next().value;if(h!==void 0)G.delete(h)}return G.set(r,n),n}function Me(e,s){e.sort((r,i)=>r[s]-i[s])}async function Ee(e){let s=new Blob([e]).stream().pipeThrough(new CompressionStream("gzip")),i=await new Response(s).arrayBuffer(),n=new Uint8Array(i),d="";for(let h=0;h<n.byteLength;h++)d+=String.fromCharCode(n[h]);return btoa(d)}async function ke(e){if(!e)return"";let s=e.trim();if(s.startsWith("{")&&s.endsWith("}"))return s;try{let r=atob(e),i=Uint8Array.from(r,(d)=>d.codePointAt(0)),n=new Blob([i]).stream().pipeThrough(new DecompressionStream("gzip"));return new Response(n).text()}catch(r){return e}}class a{static MINE_TICKS_MAX=2000;static FACTORY_TICKS_MAX=8000;static SOLAR_TICKS_MAX=1000;static COILGUN_TICKS_MAX=1000;static COILGUN_CHARGE_MAX=1000;static findArea(e){if(!t)return;let s=0;while(a.isWithinDistanceOfAny(e,e.x,e.y,75)){if(s++,s>40){console.log("too many planets");return}e.x=a.xAreaAllowed(),e.y=a.yAreaAllowed()}}static xAreaAllowed(){if(!t)return 0;let e=t.canvasWidth*0.8;return Math.random()*(e-200)}static yAreaAllowed(){if(!t)return 0;let e=t.canvasHeight*0.8;return Math.random()*(e-55)+10}static isWithinDistanceOfAny(e,s,r,i){if(!t)return!1;for(let n=0;n<t.space.planets.length;n++){let d=t.space.planets[n];if(!d||d===e)continue;if(H(s,r,d.x,d.y,i))return!0}return!1}static tick(e){if(!t)return;e.maxMines=t.hangar.maxMines,a.regenShields(e),a.tickResources(e)}static empty(e){return e.dirt<=0}static alive(e){return e.health>0}static regenShields(e){if(!a.alive(e)){e.atmo=0;return}if(e.atmo+=(e.maxAtmo-e.atmo)/100,e.atmo>e.maxAtmo)e.atmo=e.maxAtmo}static getShieldReduction(e){return e.atmo/e.maxAtmo}static takeDamage(e,s){let r=a.getShieldReduction(e),i=s*(1-r);e.atmo-=s*r;let n=0;if(e.atmo<0)n=e.atmo*-1,e.atmo=0;if(e.health-=i+n,e.health<0)e.health=0}static calcPower(e,s){if(!t)return;e.power=s*(e.isBoss?1.5:1),e.atmo=e.maxAtmo=Math.min(200,B(e.power*2+100)),e.health=e.maxHealth=B(e.power*20+1000),e.dirt=B(e.power*200+2000),e.maxMines=t.hangar.maxMines}static workConstruction(e,s){if(!a.doneFactory(e)){a.workOnFactory(e,s);return}if(!a.doneCoilgun(e)){a.workOnCoilgun(e,s);return}a.workOnMine(e,s)}static tickResources(e){if(a.empty(e))return;a.tickMines(e),a.tickBots(e),a.tickFactory(e),a.tickSolar(e),a.tickCoilgun(e)}static doneBuilding(e){return e.mines>=e.maxMines||a.empty(e)}static workOnMine(e,s){if(e.mineTicks+=s,e.mineTicks>=a.MINE_TICKS_MAX){let r=Math.floor(e.mineTicks/a.MINE_TICKS_MAX);r=Math.max(0,Math.min(r,e.maxMines-e.mines)),e.mines+=r,e.mineTicks-=r*a.MINE_TICKS_MAX}}static tickMines(e){e.ore+=e.mines}static tickBots(e){let s=Math.min(e.bots,e.ore);e.ore-=s,a.workOnSolar(e,s)}static doneFactory(e){return e.factoryTicks>=a.FACTORY_TICKS_MAX}static workOnFactory(e,s){e.factoryTicks+=s}static tickFactory(e){if(e.ore>=200){let s=Math.floor(e.ore/200);e.bots+=s,e.ore-=s*200}}static workOnSolar(e,s){if(e.solarTicks+=s,e.solarTicks>=a.SOLAR_TICKS_MAX){let r=Math.floor(e.solarTicks/a.SOLAR_TICKS_MAX);e.solar+=r,e.solarTicks-=r*a.SOLAR_TICKS_MAX}}static tickSolar(e){e.coilgunCharge+=e.solar}static doneCoilgun(e){return e.coilgunTicks>=a.COILGUN_TICKS_MAX}static workOnCoilgun(e,s){e.coilgunTicks+=s}static tickCoilgun(e){if(e.coilgunCharge>=a.COILGUN_CHARGE_MAX){let s=Math.floor(e.coilgunCharge/a.COILGUN_CHARGE_MAX);e.coilgunCharge-=s*a.COILGUN_CHARGE_MAX;let r=500*s;if(e.dirt<=r)r=e.dirt;if(e.dirt-=r,t&&t.spaceStation.orbiting[1])t.spaceStation.orbiting[1].amount+=r}}}class p{static foodPerShip=20;static actionRate=1;static actionSpeed=40;static globalTargetIndex=-1;static tick(e){p.checkEmpty(e),p.moveToNearestTarget(e),p.checkJoinFleet(e),p.attackTarget(e)}static updateGlobalTarget(){if(!t)return;let e=t.hangar.getTarget();p.globalTargetIndex=p.findClosestTarget(e.x,e.y)}static findClosestTarget(e,s){if(!t)return-1;let r=-1,i=1/0;for(let n=0;n<t.space.planets.length;n++){let d=t.space.planets[n];if(!a.doneBuilding(d)){let h=K(e,s,d.x,d.y);if(r===-1||h<i)r=n,i=h}}return r}static checkJoinFleet(e){if(!t||!e.engaged)return;for(let s=t.space.ships.length-1;s>=0;s--){let r=t.space.ships[s];if(r===e||p.isEmpty(r))continue;if(H(e.x,e.y,r.x,r.y,20))p.combineShips(e,r),t.space.ships.splice(s,1)}}static checkEmpty(e){if(e.food-=e.count,!p.isEmpty(e))return;e.food=0,e.engaged=!1,e.targetIndex=-1}static getTargetObject(e){if(!t)return null;if(e.targetIndex===-1)return t.hangar.getTarget();if(e.targetIndex>=0&&e.targetIndex<t.space.planets.length){let s=t.space.planets[e.targetIndex];if(!a.doneBuilding(s))return s}return e.targetIndex=p.findClosestTarget(e.x,e.y),e.targetIndex===-1?t.hangar.getTarget():t.space.planets[e.targetIndex]}static returnHome(e){if(!t)return;t.spaceDock.battleships+=e.count,t.spaceDock.sended-=e.count,t.farms.food+=e.food*p.foodPerShip,t.events.emit("spaceDock:updated");for(let s=t.space.ships.length-1;s>=0;s--)if(t.space.ships[s]===e){t.space.ships.splice(s,1);break}}static isEmpty(e){return e.food<=0}static getSpeed(e){if(t)return p.isEmpty(e)?t.spaceDock.emptySpeed:t.spaceDock.defaultSpeed;return p.isEmpty(e)?0.05:0.5}static moveToNearestTarget(e){let s=p.getTargetObject(e);if(!s)return;if(K(e.x,e.y,s.x,s.y)<40){if(!("isHome"in s)){e.engaged=!0;return}p.returnHome(e);return}e.engaged=!1;let r=p.getSpeed(e),i=0,n=s.y-e.y,d=s.x-e.x;if(n>=0&&d<0||n<0&&d<0)i=Math.PI;let h=Math.atan(n/d)+i;e.x=e.x+r*Math.cos(h),e.y=e.y+r*Math.sin(h),e.direction=h}static attackTarget(e){let s=p.getTargetObject(e);if(s&&!("isHome"in s)&&e.engaged){let r=s;if(e.actionCounter++,e.actionCounter>=p.actionSpeed){if(e.actionCounter=0,a.alive(r))a.takeDamage(r,p.actionRate*e.count);else if(a.workConstruction(r,e.count),a.doneBuilding(r))e.engaged=!1,e.targetIndex=p.findClosestTarget(e.x,e.y)}}}static combineShips(e,s){if(e.count+=s.count,e.energy+=s.energy,e.food+=s.food,s.actionCounter>e.actionCounter)e.actionCounter=s.actionCounter}}class X{isBoss=!1;view;x;y;mines=0;mineTicks=0;ore=0;bots=0;factoryTicks=0;solarTicks=0;solar=0;energy=0;coilgunTicks=0;coilgunCharge=0;id;power=0;atmo=0;maxAtmo=0;health=0;maxHealth=0;dirt=0;maxMines=0;constructor(){this.view={color:Math.floor(Math.random()*360),light:Math.floor(Math.random()*15+40)},this.x=a.xAreaAllowed(),this.y=a.yAreaAllowed(),a.findArea(this)}}class Y{planets;ships;sector;allEmpty;constructor(){this.planets=[],this.ships=[],this.sector=0,this.allEmpty=!1}tick(){let e=this.planets[p.globalTargetIndex];if(!e||a.doneBuilding(e))p.updateGlobalTarget();if(!this.allEmpty){let s=!0;for(let r=0;r<this.planets.length;r++)if(a.tick(this.planets[r]),s&&!a.empty(this.planets[r]))s=!1;this.allEmpty=s}if(this.allEmpty&&this.ships.length===0)this.sector++,this.newLevel();for(let s=0;s<this.ships.length;s++)p.tick(this.ships[s])}spawnShip(e,s){e.x=-120,e.y=s,this.ships.push(e)}newLevel(){this.allEmpty=!1,this.planets=[];for(let s=0;s<10;s++){let r=new X;this.planets.push(r)}Me(this.planets,"x");let e=this.planets[this.planets.length-1];if(e)e.isBoss=!0;for(let s=0;s<this.planets.length;s++)a.calcPower(this.planets[s],this.sector)}}class P{ice;buyable;gain;max;transferred;buyIncome=0;constructor(){this.ice=0,this.buyable=1000,this.gain=10,this.max=1000,this.transferred=0}tick(){if(this.transferred=0,this.buyIncome=0,this.buyable+=this.gain/100,this.buyable>this.max)this.buyable=this.max;t?.events.emit("ice:updated")}transferWater(){return this.transferred=this.ice/1000,this.ice-=this.transferred,this.transferred}buyIce(e){if(this.buyable<e)e=this.buyable;return this.buyable-=e,this.ice+=e,this.buyIncome+=e,e}findIceSeller(e){this.max+=e*200,this.gain+=e}}class V{indoor;outdoor;maxIndoor;selling;excess;gain;waterSpending=0;transferred=0;constructor(){this.indoor=0,this.outdoor=0,this.maxIndoor=50,this.selling=0,this.excess=0,this.gain=0}tick(e){if(this.indoor+=e,this.excess=this.indoor-this.maxIndoor,this.excess>0)this.indoor=this.maxIndoor,this.outdoor+=this.excess;else this.excess=0;this.selling=this.indoor/100,this.waterSpending+=this.selling,this.indoor-=this.selling;let s=this.selling*2;if(this.gain+=s,t)t.cash+=s;t?.events.emit("water:updated")}transferWater(){return this.transferred=this.outdoor/1000,this.outdoor-=this.transferred,this.transferred}sellWater(e){if(this.indoor<e)e=this.indoor;this.indoor-=e,this.waterSpending+=e;let s=this.getPrice(e);if(this.gain+=s,t)t.cash+=s}getPrice(e){return e*2}}class j{water;initialStormTimer;stormTimer;stormRate;storming;initialStormDuration;stormDuration;transferred;lightningChance;lightningStrength;constructor(){this.water=0,this.initialStormTimer=300,this.stormTimer=300,this.stormRate=0,this.storming=0,this.initialStormDuration=60,this.stormDuration=60,this.transferred=0,this.lightningChance=0,this.lightningStrength=0}tick(e){this.transferred=0,this.water+=e,this.nextStormTimer(),this.tickLightning(),t?.events.emit("clouds:updated")}tickLightning(){if(this.lightningChance+=0.01*this.stormRate/100,this.lightningStrength=this.water*0.01,this.stormRate===100&&this.lightningChance>Math.random()*100){if(this.lightningChance=0,t)t.energy.gainEnergy(this.lightningStrength)}}transferWater(){return this.transferred=this.water/500*this.stormRate/100,this.water-=this.transferred,this.transferred}nextStormTimer(){if(this.stormTimer>0)this.stormTimer--;else if(this.stormDuration>0)this.storming=1;if(this.stormRate>=100)if(this.storming=0,this.stormDuration>0)this.storming=0,this.stormDuration--;else this.storming=-1;else if(this.stormRate<=0&&this.storming===-1)this.stormDuration=this.initialStormDuration,this.stormTimer=this.initialStormTimer,this.storming=0;this.stormRate+=this.storming}gainStormDuration(e){this.stormDuration+=e,this.initialStormDuration+=e,t?.events.emit("clouds:stormDuration:updated")}}class ${land;baseLand;optimizedLand;water;soil;transferred;convertedLand=0;constructor(e){this.land=e,this.baseLand=e,this.optimizedLand=e,this.water=0,this.soil=0,this.transferred=0}tick(e){this.transferred=0,this.water+=e,this.turnLandToSoil(),t?.events.emit("land:updated")}turnLandToSoil(){if(this.convertedLand=this.water/1000,this.land<this.convertedLand)this.convertedLand=this.land;this.land-=this.convertedLand,this.soil+=this.convertedLand,this.water-=this.convertedLand}transferWater(){return this.transferred=this.water/1000,this.water-=this.transferred,this.transferred}improveLand(){let e=(10*this.baseLand-this.optimizedLand)/100;this.optimizedLand+=e,this.land+=e,t?.robots.updateMinesLimit()}addLand(e){this.optimizedLand+=e,this.land+=e,this.baseLand+=e,t?.robots.updateMinesLimit()}}class D{water;ferns;fernsDelta;fernsWaterUse;smallTrees;smallTreesDelta;smallTreesWaterUse;trees;treesDelta;treesWaterUse;totalPlants;oxygenGain;woodIncome=0;woodSpending=0;waterSpending=0;transferred=0;constructor(){this.water=0,this.ferns=0,this.fernsDelta=0,this.fernsWaterUse=0,this.smallTrees=0,this.smallTreesDelta=0,this.smallTreesWaterUse=0,this.trees=0,this.treesDelta=0,this.treesWaterUse=0,this.totalPlants=0,this.oxygenGain=0}tick(e){if(!t)return;this.transferred=0,this.oxygenGain=0,this.woodIncome=0,this.woodSpending=0,this.waterSpending=0,this.water+=e,this.plantGrowth(),this.oxygenGain=this.ferns/1000+3*this.smallTrees/1000+this.trees/100,t.oxygen+=this.oxygenGain,t.events.emit("trees:updated")}plantGrowth(){if(!t)return;if(this.totalPlants=this.ferns+this.smallTrees+this.trees,this.treesDelta=this.smallTrees/1000,this.smallTreesDelta=this.ferns/1000-this.treesDelta,this.fernsDelta=(t.land.soil-this.totalPlants)/1000-this.ferns/1000,this.fernsWaterUse=(t.land.soil-this.totalPlants)/1000,this.fernsWaterUse=this.fernsWaterUse<0?0:this.fernsWaterUse,this.smallTreesWaterUse=this.ferns/1000,this.treesWaterUse=this.smallTrees/1000,this.fernsDelta<0){let e=0;if(this.ferns+this.fernsDelta<0)e=this.fernsDelta+this.ferns,this.fernsDelta=-1*this.ferns;if(this.smallTreesDelta+=e,e=0,this.smallTrees+this.smallTreesDelta<0)e=this.smallTrees+this.smallTreesDelta,this.smallTreesDelta=-1*this.smallTrees;this.treesDelta+=e}if(this.water<this.treesWaterUse)this.treesDelta=this.treesDelta>0?this.water:this.treesDelta,this.treesWaterUse=this.water;if(this.trees+=this.treesDelta,this.water-=this.treesWaterUse,this.waterSpending+=this.treesWaterUse,this.water<this.smallTreesWaterUse)this.smallTreesDelta=this.smallTreesDelta>0?this.water:this.smallTreesDelta,this.smallTreesWaterUse=this.water;if(this.smallTrees+=this.smallTreesDelta,this.water-=this.smallTreesWaterUse,this.waterSpending+=this.smallTreesWaterUse,this.water<this.fernsWaterUse)this.fernsDelta=this.fernsDelta>0?this.water:this.fernsDelta,this.fernsWaterUse=this.water;this.ferns+=this.fernsDelta,this.water-=this.fernsWaterUse,this.waterSpending+=this.fernsWaterUse}transferWater(){return this.transferred=this.water/1000,this.water-=this.transferred,this.transferred}}class J{water;farms;food;foodCreated;efficiency;farmRatio;waterSpending=0;transferred=0;constructor(){this.water=0,this.farms=0,this.food=0,this.foodCreated=0,this.efficiency=1,this.farmRatio=0}tick(e){this.transferred=0,this.foodCreated=0,this.waterSpending=0,this.water+=e,this.gainFood(),t?.events.emit("farms:updated")}transferWater(){return this.transferred=this.water/1000,this.water-=this.transferred,this.transferred}gainFood(){if(this.foodCreated=this.farms/100*this.efficiency,this.foodCreated>this.water)this.foodCreated=this.water;this.waterSpending+=this.foodCreated,this.water-=this.foodCreated,this.food+=this.foodCreated}addFarm(e){this.farms+=e,t?.events.emit("farms:updated")}updateFarms(e){let s=e+this.farms*50,r=Math.floor(s*this.farmRatio/100/50),i=r-this.farms;if(i!==0)return this.farms=r,t?.events.emit("farms:updated"),i*50;return 0}improve(){this.efficiency+=0.02,t?.events.emit("farms:updated")}}class Q{people;foodEaten;popGrowth;starving;scienceRatio;scienceDelta;cashDelta;happiness;houseBonus;happinessFromTrees=0;happinessFromOxygen=0;constructor(){this.people=0,this.foodEaten=0,this.popGrowth=0,this.starving=0,this.scienceRatio=0,this.scienceDelta=0,this.cashDelta=0,this.happiness=1,this.houseBonus=1}tick(){if(!t)return;if(this.foodEaten=this.people/100,this.foodEaten>t.farms.food)this.starving=this.foodEaten-t.farms.food,this.foodEaten=t.farms.food;else this.starving=0;t.farms.food-=this.foodEaten,this.popGrowth=(t.farms.food-this.people)/1000-this.starving/100,this.people+=this.popGrowth,this.updateHappiness(),this.tickRatio(),t.events.emit("population:updated")}updateHappiness(){if(!t)return;this.happinessFromTrees=Math.log10(t.trees.trees+1)/10,this.happinessFromOxygen=Math.log10(t.oxygen+1)/20,this.happiness=this.houseBonus*(1+this.happinessFromTrees+this.happinessFromOxygen)}tickRatio(){if(!t)return;this.scienceDelta=this.people/100*(100-this.scienceRatio)/100*this.happiness,this.cashDelta=this.people/100*this.scienceRatio/100*this.happiness,t.science+=this.scienceDelta,t.cash+=this.cashDelta}improveHouse(){this.houseBonus+=0.1}}class y{text;tooltip;workers;currentTicks=0;ticksNeeded;cost;costType;completions=0;isMoving=!1;spendingCategory;finish;showing;done;constructor(e){this.text=e.text||"",this.tooltip=e.tooltip||"",this.workers=e.workers||e.threads||0,this.currentTicks=e.currentTicks||0,this.ticksNeeded=e.ticksNeeded||0,this.cost=e.cost??0,this.costType=e.costType??"",this.spendingCategory=e.spendingCategory,this.finish=e.finish||(()=>{}),this.showing=e.showing!==void 0?e.showing:!0,this.done=e.done}tick(e,s=1,r){if(e===0||this.done&&this.done())return this.isMoving=!1,0;if(this.ticksNeeded===0)return this.finish(),0;if(this.cost&&this.costType){let n=Array.isArray(this.cost)?this.cost:[this.cost],d=Array.isArray(this.costType)?this.costType:[this.costType];for(let h=0;h<n.length;h++){let m=e*n[h]*s,b=d[h];if(b&&t&&t[b]<m)return this.isMoving=!1,0}for(let h=0;h<n.length;h++){let m=e*n[h]*s,b=d[h];if(b&&t){if(t[b]-=m,r)r(b,m)}}}this.currentTicks+=e,this.isMoving=!0;let i=0;while(this.currentTicks>=this.ticksNeeded)this.currentTicks-=this.ticksNeeded,this.completions++,this.finish(),i++;return i}}class A{unlocked;threads;freeThreads;speed;processes;cashSpending=0;scienceSpending=0;metalSpending=0;woodSpending=0;powerSpending=0;static UNLOCK_SCIENCE_COST=1000;constructor(){if(this.unlocked=!1,this.threads=1,this.freeThreads=1,this.speed=1,this.processes=[new y({text:"Optimize Land",tooltip:"Improve 1% of unimproved land.<br>Max to improve to is ( 10 x base land )<br>Percent Optimized: <div id='landOptimized'></div>",ticksNeeded:600,finish:function(){if(t)t.land.improveLand();if(t)this.ticksNeeded=Math.floor(t.land.baseLand);t?.events.emit("computer:optimize-land:updated")}}),new y({text:"Buy Ice",tooltip:"Buy available ice",ticksNeeded:50,finish:function(){if(t)t.buyIce()}}),new y({text:"Sell Water",tooltip:"Sells up to 50 water",ticksNeeded:50,finish:function(){if(t)t.water.sellWater(50)}}),new y({text:"Improve Farms",tooltip:"Farm efficiency increases by 2%",ticksNeeded:40,finish:function(){if(t)t.farms.improve();this.ticksNeeded=B(20*(this.completions+2)+Math.pow(this.completions,2)/10)}}),new y({text:"Find more Ice Sellers",tooltip:"Gain 200 buyable ice and 1 more per tick",ticksNeeded:2000,cost:0.5,costType:"cash",finish:function(){if(t)t.ice.findIceSeller(1)}}),new y({text:"Bigger Storms",tooltip:"Storms last 5 more ticks. Max 300 duration.",ticksNeeded:600,cost:2,costType:"science",finish:function(){if(t)t.clouds.gainStormDuration(5);this.cost=this.cost+0.5,this.ticksNeeded+=50},done:function(){if(t&&t.clouds.initialStormDuration>=300)return this.showing=!1,t.events.emit("computer:visibility:updated"),!0;return!1},showing:!0}),new y({text:"Build Robots",tooltip:"Builds a robot",ticksNeeded:1e4,cost:0.01,costType:"metal",finish:function(){if(t)t.robots.gainRobots(1)},showing:!1,done:function(){return t?t.robots.robots>=t.robots.robotMax:!1}}),new y({text:"More Robot Storage",tooltip:"Can hold 5 more robots",ticksNeeded:20000,cost:0.5,costType:"wood",finish:function(){if(t)t.robots.gainStorage(5);this.ticksNeeded+=2000},showing:!1}),new y({text:"Improve House Design",tooltip:"Improves base happiness modifier by .1",ticksNeeded:3000,cost:10,costType:"science",finish:function(){if(t)t.population.improveHouse();this.ticksNeeded+=500},showing:!1}),new y({text:"Improve Ship engines",tooltip:"Ship speed increases by 0.1 and empty ship speed by 0.01",ticksNeeded:20000,cost:1e4,costType:"science",finish:function(){if(t)t.spaceDock.improveEngines(0.1,0.01);this.cost=this.cost+5000,this.ticksNeeded+=1000},done:function(){if(t&&t.spaceDock.defaultSpeed>=1)return this.showing=!1,t.events.emit("computer:visibility:updated"),!0;return!1},showing:!1})],t)t.events.on("computer:unlocked",()=>{let e=["Build Robots","More Robot Storage","Improve House Design"];if(t&&t.robots.unlocked)this.processes.filter((s)=>e.includes(s.text)).forEach((s)=>s.showing=!0)}),t.events.on("robots:unlocked",()=>{let e=["Build Robots","More Robot Storage","Improve House Design"];this.processes.filter((s)=>e.includes(s.text)).forEach((s)=>s.showing=!0)}),t.events.on("spaceDock:unlocked",()=>{let e=this.processes.find((s)=>s.text==="Improve Ship engines");if(e)e.showing=!0})}tick(){this.cashSpending=0,this.scienceSpending=0,this.metalSpending=0,this.woodSpending=0,this.powerSpending=0;for(let e=0;e<this.processes.length;e++){let s=this.processes[e];this.tickRow(s,this.speed*s.workers)}}tickRow(e,s){if(!t)return;if(s===0){e.isMoving=!1;return}if(e.done&&e.done()){if(e.isMoving=!1,e.workers>0)this.freeThreads+=e.workers,e.workers=0;t.events.emit("computer:threads:updated");return}e.tick(s,1,(r,i)=>{let n=e.spendingCategory?.[r]||r+"Spending";if(this[n]!==void 0&&typeof this[n]==="number")this[n]+=i})}unlockComputer(){if(!t)return;if(t.science>=A.UNLOCK_SCIENCE_COST)t.science-=A.UNLOCK_SCIENCE_COST,this.unlocked=!0,t.events.emit("computer:unlocked")}buyThread(){if(!t)return;let e=this.getThreadCost();if(t.cash>=e)t.cash-=e,this.threads++,this.freeThreads++,t.events.emit("computer:threads:updated")}getThreadCost(){return Te(Math.pow(2,this.threads)*500)}buySpeed(){if(!t)return;let e=this.getSpeedCost();if(t.science>=e)t.science-=e,this.speed++,t.events.emit("computer:speed:updated")}getSpeedCost(){return Te(Math.pow(2,this.speed)*500)}addThread(e,s){s=Math.min(s,this.freeThreads);let r=this.processes[e];if(r)r.workers+=s,this.freeThreads-=s,t?.events.emit("computer:threads:updated")}removeThread(e,s){let r=this.processes[e];if(r)s=Math.min(s,r.workers),r.workers-=s,this.freeThreads+=s,t?.events.emit("computer:threads:updated")}}class I{robots;robotsFree;robotMax;unlocked;mines;minesLimit;jobs;woodIncome=0;woodSpending=0;metalIncome=0;metalSpending=0;oreIncome=0;oreSpending=0;oreToDirtSpending=0;oxygenSpending=0;powerSpending=0;static UNLOCK_CASH_COST=3000;constructor(){this.robots=0,this.robotsFree=0,this.robotMax=5,this.unlocked=!1,this.mines=0,this.minesLimit=1,this.jobs=[new y({text:"Cut Trees",tooltip:"Cut down 2 trees for 1 wood",finish:function(){if(t)t.robots.cutTrees(this.workers)}}),new y({text:"Expand indoor water storage",tooltip:"Gives 50 more max indoor water.<br>Cost increases by 1",ticksNeeded:3000,cost:[0.1],costType:["metal"],finish:function(){if(this.ticksNeeded+=1000,t)t.water.maxIndoor+=50,t.events.emit("water:maxIndoor:updated")}}),new y({text:"Build Mines",tooltip:"Build mines to get ore. Limit: <span id='minesLimit'></span>. Currently: <span id='minesCount'></span>",ticksNeeded:300,cost:[1],costType:["wood"],finish:function(){if(t)t.robots.mines++,t.events.emit("robots:mines:updated");this.ticksNeeded+=200+this.completions*50},done:function(){if(!t)return!1;return t.robots.mines>=t.robots.minesLimit}}),new y({text:"Mine Ore",tooltip:"Get (mines / 100) ore per tick",finish:function(){if(t)t.robots.mineOre(this.workers)}}),new y({text:"Smelt Ore",tooltip:"Each tick costs 5 wood, 1 ore, and 1000 oxygen<br>Gain 1 metal",finish:function(){if(t)t.robots.smeltOre(this.workers)}}),new y({text:"Turn ore into dirt",tooltip:"Each tick costs 1 energy and 1000 ore<br>Gain 5 Base Land<br>Total land gained: <span id='totalDirtFromOre'></span>",ticksNeeded:1000,cost:[1,1000],costType:["power","ore"],spendingCategory:{ore:"oreToDirtSpending"},finish:function(){if(t)t.land.addLand(50)},showing:!1})]}tick(){this.woodIncome=0,this.woodSpending=0,this.metalIncome=0,this.metalSpending=0,this.oreIncome=0,this.oreSpending=0,this.oreToDirtSpending=0,this.oxygenSpending=0,this.powerSpending=0;for(let e=0;e<this.jobs.length;e++)this.tickRow(this.jobs[e],this.jobs[e].workers)}tickRow(e,s){if(!t)return;if(e.tick(s,1,(i,n)=>{let d=e.spendingCategory?.[i]||i+"Spending";if(this[d]!==void 0&&typeof this[d]==="number")this[d]+=n})>0)t.events.emit("robots:count:updated")}gainRobots(e){this.robots+=e,this.robotsFree+=e,t?.events.emit("robots:count:updated")}gainStorage(e){this.robotMax+=e,t?.events.emit("robots:storage:updated")}unlockRobots(){if(!t)return;if(t.cash>=I.UNLOCK_CASH_COST)t.cash-=I.UNLOCK_CASH_COST,this.unlocked=!0,t.events.emit("robots:unlocked"),this.gainRobots(1);t.events.emit("robots:count:updated"),t.events.emit("robots:storage:updated")}addWorker(e,s){let r=this.jobs[e];if(r)s=Math.min(s,this.robotsFree),r.workers+=s,this.robotsFree-=s;t?.events.emit("robots:count:updated")}removeWorker(e,s){let r=this.jobs[e];if(r)s=Math.min(s,r.workers),r.workers-=s,this.robotsFree+=s;t?.events.emit("robots:count:updated")}updateMinesLimit(){if(!t)return;let e=t.land.optimizedLand/100,s=Math.floor(Math.sqrt(e))+1;if(s!==this.minesLimit)this.minesLimit=s,t.events.emit("robots:minesLimit:updated")}cutTrees(e){if(t&&t.trees.trees>=2*e)t.trees.trees-=2*e,t.wood+=e,this.woodIncome+=e}mineOre(e){if(t){let s=t.robots.mines/100*e;t.ore+=s,this.oreIncome+=s}}smeltOre(e){if(t&&t.wood>=5*e&&t.ore>=e&&t.oxygen>=e*1000)t.wood-=5*e,t.ore-=e,t.oxygen-=1000*e,t.metal+=e,this.woodSpending+=5*e,this.oreSpending+=e,this.oxygenSpending+=1000*e,this.metalIncome+=e}}class T{unlocked;battery;drain=0;powerPerTick=0;static UNLOCK_METAL_COST=500;static BATTERY_OXYGEN_COST=30000;static BATTERY_SCIENCE_COST=20000;constructor(){this.unlocked=!1,this.battery=100}unlockEnergy(){if(t&&t.metal>=T.UNLOCK_METAL_COST)t.metal-=T.UNLOCK_METAL_COST,this.unlocked=!0,t.events.emit("energy:unlocked");t?.events.emit("energy:battery:updated")}tick(){if(!t)return;let e=t.computer.powerSpending,s=t.robots.powerSpending,r=t.spaceStation.powerSpending,i=t.tractorBeam.comets.length>0?t.power/1000:0;this.drain=e+s+r+i;let n=t.dysonSwarm.getPowerProduction();if(t.power<this.battery)t.power+=Math.min(n,this.battery-t.power);if(t.power-=this.drain,t.power>this.battery)t.power-=(t.power-this.battery)*0.02;if(t.power<0)t.power=0;this.powerPerTick=n,t.events.emit("energy:updated")}gainEnergy(e){if(t)t.power+=e}buyBattery(e){this.battery+=e,t?.events.emit("energy:battery:updated")}}class L{unlocked;orbiting;waterIncome=0;powerSpending=0;static UNLOCK_METAL_COST=2000;static UNLOCK_WOOD_COST=20000;constructor(){this.unlocked=!1,this.orbiting=[{type:"ice",amount:1e6},{type:"dirt",amount:500}]}unlockSpaceStation(){if(t&&t.metal>=L.UNLOCK_METAL_COST&&t.wood>=L.UNLOCK_WOOD_COST)t.metal-=L.UNLOCK_METAL_COST,t.wood-=L.UNLOCK_WOOD_COST,this.unlocked=!0,t.events.emit("spaceStation:unlocked");t?.events.emit("spaceStation:updated")}tick(){if(this.waterIncome=0,!this.unlocked||!t)return;for(let e=0;e<this.orbiting.length;e++){let s=this.orbiting[e],r=s.amount/1e5;s.amount-=r;let i=s.type;if(i==="ice")t.ice.ice+=r,this.waterIncome+=r;else if(i==="dirt")t.land.addLand(r)}}}function q(e,s,r){let i=e*s,n=r*(i*0.4)+i*0.1,d=Math.pow(Math.pow(i,2)-Math.pow(n,2),0.5),h=(0-n)/d;return{startingY:n,endingX:d,slope:h}}class _{unlocked;cometSpotChance;takeAmount;comets;static UNLOCK_SCIENCE_COST=500000;static UNLOCK_OXYGEN_REQ=5000000;static UNLOCK_OXYGEN_REDUCE=2000000;constructor(){this.unlocked=!1,this.cometSpotChance=0.006,this.takeAmount=[{type:"ice",amount:0},{type:"dirt",amount:0}],this.comets=[]}tick(){if(!this.unlocked||!t)return;if(this.checkForNewAsteroids(),this.comets.length){let e=t.power/1000;this.pullIntoOrbit(e),this.removeAsteroidIfDone()}}unlockTractorBeam(){if(!t)return;if(t.science>=_.UNLOCK_SCIENCE_COST&&t.oxygen>=_.UNLOCK_OXYGEN_REQ)t.science-=_.UNLOCK_SCIENCE_COST,t.oxygen-=_.UNLOCK_OXYGEN_REDUCE,this.unlocked=!0,t.events.emit("tractorBeam:unlocked"),t.spaceDock.unlocked=!0,t.events.emit("spaceDock:unlocked");t.events.emit("tractorBeam:updated")}pullIntoOrbit(e){if(!t)return 0;let s=e/this.comets.length,r=0;for(let i=0;i<t.spaceStation.orbiting.length;i++){let n=t.spaceStation.orbiting[i],d=0;for(let m=0;m<this.comets.length;m++){let b=this.comets[m];if(b.amountType===n.type){let S=Math.min(s,b.amount);r+=S,b.amount-=S,d+=S}}n.amount+=d;let h=this.takeAmount.find((m)=>m.type===n.type);if(h)h.amount=d;else this.takeAmount.push({type:n.type,amount:d})}return r}checkForNewAsteroids(){if(Math.random()<this.cometSpotChance)this.addComet()}removeAsteroidIfDone(){let e=this.comets.length-1;for(let s=e;s>=0;s--){let r=this.comets[s];if(r.duration--,r.duration<0||r.amount<1){if(r.drawed)t?.events.emit("tractorBeam:removeComet",r);this.comets.splice(s,1)}}}addComet(){if(!t||this.comets.length>20)return;let e=Math.random(),s=Math.random()*100*t.space.sector+200,r=Math.floor(Math.random()*800+400),i=Math.random()*2+1,n={};if(e<0.9)n={name:"Comet",amountType:"ice",amount:s*1000,initialAmount:s*1000,duration:r,initialDuration:r,speed:i};else n={name:"Asteroid",amountType:"dirt",amount:s,initialAmount:s,duration:r*2,initialDuration:r*2,speed:i/2};n.id=Fe(),n.drawed=!1;let d=q(n.speed||0,n.duration||0,Math.random());n.startingY=d.startingY,n.endingX=d.endingX,n.slope=d.slope,n.left=0,this.comets.push(n)}}class w{battleships;unlocked;sended;defaultSpeed=0.5;emptySpeed=0.05;static BATTLESHIP_OXYGEN_COST=30000000;static BATTLESHIP_SCIENCE_COST=15000000;constructor(){this.battleships=0,this.unlocked=!1,this.sended=0}addBattleship(e){this.battleships+=e,t?.events.emit("spaceDock:updated")}improveEngines(e,s){this.defaultSpeed+=e,this.emptySpeed+=s,t?.events.emit("spaceDock:updated")}}class Z{count;food;actionCounter;energy;x;y;engaged;direction;targetIndex;constructor(e,s,r){this.count=e,this.food=s/r,this.actionCounter=0,this.energy=0,this.x=0,this.y=0,this.engaged=!1,this.direction=0,this.targetIndex=-1}}class v{sendRate;timeRemaining;totalTime;y;maxMines;static METAL_COST_PER_RATE=1e6;constructor(){this.sendRate=1,this.timeRemaining=this.totalTime=40,this.y=(t?.canvasHeight||600)*0.5-25,this.maxMines=10}tick(){if(!t)return;if(this.y=t.canvasHeight*0.5-25,this.timeRemaining--,this.timeRemaining<0)if(t.spaceDock.battleships>0&&!t.space.allEmpty){let e=Math.min(this.sendRate,t.spaceDock.battleships),s=t.farms.food*0.05;t.farms.food-=s;let r=new Z(e,s,p.foodPerShip);r.targetIndex=p.globalTargetIndex,t.space.spawnShip(r,this.y),t.spaceDock.battleships-=e,t.spaceDock.sended+=e,t.events.emit("spaceDock:updated"),this.timeRemaining=this.totalTime}else this.timeRemaining=0}getTarget(){return{isHome:!0,x:-125,y:this.y}}}class E{unlocked=!1;satellites=0;static SATELLITE_METAL_COST=1e5;static SATELLITE_SCIENCE_COST=1e8;static POWER_PER_SATELLITE=100;static UNLOCK_METAL_COST=1e7;static UNLOCK_SCIENCE_COST=1000000000000;unlockDysonSwarm(){if(!t)return;if(t.science>=E.UNLOCK_SCIENCE_COST&&t.metal>=E.UNLOCK_METAL_COST)t.science-=E.UNLOCK_SCIENCE_COST,t.metal-=E.UNLOCK_METAL_COST,this.unlocked=!0,t.events.emit("dysonSwarm:unlocked");t.events.emit("dysonSwarm:updated")}buySatellites(e){if(!t||!this.unlocked)return;let s=e*E.SATELLITE_METAL_COST,r=e*E.SATELLITE_SCIENCE_COST;if(t.metal>=s&&t.science>=r)t.metal-=s,t.science-=r,this.satellites+=e,t.events.emit("dysonSwarm:updated")}tick(){if(!this.unlocked||!t)return}getPowerProduction(){return this.satellites*E.POWER_PER_SATELLITE}}class U{aProgress;color;lastPercentage=-1;constructor(e,s){this.aProgress=document.getElementById(e),this.color=s}tick(e,s){if(!this.aProgress||s<=0)return;let r=e/s;if(Math.abs(this.lastPercentage-r)<0.001)return;this.lastPercentage=r,this.reset(this.aProgress),this.drawProgress(this.aProgress,r,this.color)}reset(e){if(!e)return;let s=e.getContext("2d");if(!s)return;s.lineCap="square";let r=e.width/2,i=e.width/2-5;s.beginPath(),s.lineWidth=8,s.fillStyle="#1e1e1e",s.arc(r,r,i,0,2*Math.PI),s.fill()}drawProgress(e,s,r){if(!e)return;let i=e.getContext("2d");if(!i)return;let n=Math.PI/2,d=2*s*0.95*Math.PI-n*0.9,h=0-n*0.9,m=e.width/2,b=e.width/2-10;i.lineCap="square",i.beginPath(),i.lineWidth=8,i.strokeStyle=r,i.arc(m,m,b,h,d),i.stroke()}}var C=document.getElementById("spaceCanvas"),u=C?C.getContext("2d"):null;if(u)u.font="13px Arial";var W=240,Se={x:0,y:0};function Be(){if(!C||!t)return;if(C.width!==t.canvasWidth||C.height!==t.canvasHeight){if(C.width=t.canvasWidth,C.height=t.canvasHeight,W=C.width/5,u)u.font="13px Arial"}}if(C)window.addEventListener("resize",Be),Be(),C.addEventListener("mousemove",function(e){Se={x:e.offsetX-W,y:e.offsetY}});function xe(){if(!u||!t||!C)return;u.clearRect(0,0,C.width,C.height),$e(),je(),Ve()}function Ve(){if(!t)return;for(let e=0;e<t.space.planets.length;e++)Qe(t.space.planets[e])}function je(){if(!t)return;for(let e=0;e<t.space.ships.length;e++)De(t.space.ships[e])}function $e(){if(!t)return;for(let e=0;e<t.space.planets.length;e++){let s=t.space.planets[e];Je(s,s.isBoss?"B":(e+1).toString())}}function De(e){if(!u)return;let s=e.x+W,r=p.getTargetObject(e);if(e.engaged&&r&&e.actionCounter<10){let m="isHome"in r,b=we(!m?r.isBoss:!1);u.save(),u.beginPath(),u.strokeStyle="rgba(255, 50, 50, "+(1-e.actionCounter/10)+")",u.lineWidth=3,u.moveTo(s+25,e.y+25),u.lineTo(r.x+W+b,r.y+b),u.stroke(),u.restore()}u.save(),u.translate(s+25,e.y+25),u.rotate(e.direction);let i={x:-10,y:-10},n={x:10,y:0},d={x:-10,y:10},h={x:-7,y:0};u.beginPath(),u.fillStyle="#008080",u.lineWidth=3,u.moveTo(i.x,i.y),u.lineTo(n.x,n.y),u.lineTo(d.x,d.y),u.lineTo(h.x,h.y),u.fill(),u.restore(),u.save(),u.translate(s+25,e.y+25),u.fillStyle="white",u.fillText(o(e.count),-4,20),u.fillText(o(e.food/e.count/10,1),-4,30),u.restore()}function Je(e,s){if(!u)return;let r=we(e.isBoss),i=e.x+W;u.save(),u.translate(i+r,e.y+r),qe(e,r),Ze(e,r),ze(e,r),u.fillStyle="white",u.fillText(s,-3,4),u.restore()}function Qe(e){if(!u)return;let s=we(e.isBoss),r=e.x+W;if(!H(Se.x,Se.y,e.x+s,e.y+s,50))return;u.save(),u.translate(r+s,e.y+s),u.fillStyle="#ffffff",u.fillText("Atmosphere: "+o(e.atmo),-15,s),u.fillText("Reduction: "+o(a.getShieldReduction(e)*100)+"%",-15,s+10),u.fillText("Health: "+o(e.health),-15,s+20),u.fillText("Dirt: "+o(e.dirt),-15,s+30),u.fillText("Ore: "+o(e.ore),-15,s+40),u.fillText("C.Bots: "+o(e.bots)+" / "+o(e.maxMines),-15,s+50),u.fillText("Solar: "+o(e.solar),-15,s+60),u.fillText("Build Factory: "+o(e.factoryTicks)+" / "+o(a.FACTORY_TICKS_MAX),-15,s+70),u.fillText("Build Coilgun: "+o(e.coilgunTicks)+" / "+o(a.COILGUN_TICKS_MAX),-15,s+80),u.fillText("Coilgun Charge: "+o(e.coilgunCharge)+" / "+o(a.COILGUN_CHARGE_MAX),-15,s+90),u.fillText("Build Solar: "+o(e.solarTicks)+" / "+o(a.SOLAR_TICKS_MAX),-15,s+100),u.fillText("Mines: "+o(e.mines)+" / "+o(e.maxMines),-15,s+110),u.fillText("Build Mine: "+o(e.mineTicks)+" / "+o(a.MINE_TICKS_MAX),-15,s+120),u.restore()}function qe(e,s){if(!u)return;let r=s*(e.atmo/e.maxAtmo/2+0.5),i=u.createRadialGradient(0,0,r*1.1,0,0,r/3.3);i.addColorStop(0,"black");let n="hsl("+(e.view.color+120)+",90%,60%)";i.addColorStop(1,n),u.fillStyle=i,u.fillRect(-s,-s,s*2,s*2),u.beginPath(),u.strokeStyle="#008080",u.lineWidth=3,u.arc(0,0,s-4,0,2*Math.PI*(e.atmo/e.maxAtmo)),u.stroke()}function Ze(e,s){if(!u)return;u.beginPath();let r=Math.floor(e.health/e.maxHealth*70+10);u.fillStyle="hsl("+e.view.color+","+r+"%,"+e.view.light+"%)",u.arc(0,0,s/2,0,2*Math.PI),u.fill(),u.beginPath(),u.strokeStyle="#b6000b",u.lineWidth=3,u.moveTo(-s*2/3,-s),u.lineTo(-s*2/3+s*4/3*(e.health/e.maxHealth),-s),u.stroke()}function ze(e,s){if(!u||a.empty(e))return;let r=Math.PI/2,i=-r;if(e.factoryTicks>0&&e.factoryTicks<a.FACTORY_TICKS_MAX){let d=2*(e.factoryTicks/a.FACTORY_TICKS_MAX)*Math.PI-r;u.beginPath(),u.strokeStyle="#888888",u.lineWidth=2,u.arc(0,0,s*0.9,i,d),u.stroke()}if(e.coilgunTicks>0&&e.coilgunTicks<a.COILGUN_TICKS_MAX){let d=2*(e.coilgunTicks/a.COILGUN_TICKS_MAX)*Math.PI-r;u.beginPath(),u.strokeStyle="#884400",u.lineWidth=2,u.arc(0,0,s*0.8,i,d),u.stroke()}if(e.coilgunTicks>=a.COILGUN_TICKS_MAX&&e.coilgunCharge>0){let d=2*(e.coilgunCharge/a.COILGUN_CHARGE_MAX)*Math.PI-r;u.beginPath(),u.strokeStyle="#ffcc00",u.lineWidth=2,u.arc(0,0,s*0.8,i,d),u.stroke()}if(e.solar>0||e.solarTicks>0){let d=2*(e.solarTicks/a.SOLAR_TICKS_MAX)*Math.PI-r;u.beginPath(),u.strokeStyle="#4444ff",u.lineWidth=2,u.arc(0,0,s*0.7,i,d),u.stroke()}if(e.mines<e.maxMines&&e.mineTicks>0){let d=2*(e.mineTicks/a.MINE_TICKS_MAX)*Math.PI-r;u.beginPath(),u.strokeStyle="#666666",u.lineWidth=2,u.arc(0,0,s*0.6,i,d),u.stroke()}}function we(e){return e?40:25}class l{textCache=new Map;elementCache=new Map;clearCache(){this.textCache.clear(),this.elementCache.clear()}getAmount(e){if(!this.elementExists(e))return 1;let s=this.getElement(e);return Number(s.value)||1}setupAmountCostListener(e,s){if(!this.elementExists(e))return;let r=this.getElement(e),i=()=>{let n=this.getAmount(e);this.updateCostSpans(n,s)};r.addEventListener("change",i),r.addEventListener("input",i)}updateCostSpans(e,s){for(let r of s)if(this.elementExists(r.spanId))this.updateElementText(r.spanId,o(e*r.costPerUnit))}getElement(e){let s=this.elementCache.get(e);if(!s){let r=document.getElementById(e);if(!r)throw Error(`Element ${e} not found`);s=r,this.elementCache.set(e,s)}return s}updateElementText(e,s){if(this.textCache.get(e)===s)return;this.getElement(e).textContent=s,this.textCache.set(e,s)}updateElementHTML(e,s){if(this.textCache.get(e)===s)return;this.getElement(e).innerHTML=s,this.textCache.set(e,s)}elementExists(e){return this.elementCache.has(e)||document.getElementById(e)!==null}setVisible(e,s){if(!this.elementExists(e))return;let r=this.getElement(e);if(s)r.classList.remove("hidden");else r.classList.add("hidden")}updateFull(){this.update()}}class c{static pendingNotifications=new Map;static specialEvents=[];static notifiedThisCycle=new Set;static initialized=!1;static isBatching=!1;static init(){if(this.initialized)return;document.addEventListener("visibilitychange",()=>{if(!document.hidden)this.flush()}),this.initialized=!0}static startBatch(){this.isBatching=!0,this.notifiedThisCycle.clear()}static endBatch(){if(this.isBatching=!1,!document.hidden)this.flush()}static on(e,s,r){if(!e)return;this.init(),e.on(s,(...i)=>{if(document.hidden||this.isBatching)if(s==="tractorBeam:removeComet")this.specialEvents.push({listener:r,args:i});else this.pendingNotifications.set(r,i);else r(...i)})}static notifyOnlyOnce(e,s){let r=s||e;if(this.notifiedThisCycle.has(r))return;this.notifiedThisCycle.add(r),e()}static flush(){if(this.pendingNotifications.size===0&&this.specialEvents.length===0){this.notifiedThisCycle.clear();return}let e=new Map(this.pendingNotifications);this.pendingNotifications.clear();let s=[...this.specialEvents];this.specialEvents=[],this.notifiedThisCycle.clear(),s.forEach((r)=>r.listener(...r.args)),e.forEach((r,i)=>i(...r)),this.notifiedThisCycle.clear()}}class z extends l{rows=new Map;constructor(){super();if(t)c.on(t.events,"computer:unlocked",()=>this.checkUnlocked()),c.on(t.events,"computer:threads:updated",()=>this.updateThreads()),c.on(t.events,"computer:speed:updated",()=>this.updateSpeed()),c.on(t.events,"computer:optimize-land:updated",()=>this.updateLandOptimized()),c.on(t.events,"robots:unlocked",()=>this.updateVisibility()),c.on(t.events,"spaceDock:unlocked",()=>this.updateVisibility()),c.on(t.events,"computer:visibility:updated",()=>this.updateVisibility())}checkUnlocked(){if(!t)return;if(this.updateElementText("unlockComputerCost",o(A.UNLOCK_SCIENCE_COST)),t.computer.unlocked)this.setVisible("unlockedComputer",!0),this.setVisible("unlockComputer",!1),this.setVisible("robotsContainer",!0),this.updateThreads(),this.updateSpeed(),this.updateVisibility();else this.setVisible("unlockedComputer",!1),this.setVisible("unlockComputer",!0),this.setVisible("robotsContainer",!1)}updateVisibility(){if(!t)return;for(let e=0;e<t.computer.processes.length;e++){let s=t.computer.processes[e];if(!s)continue;this.setVisible("computerRow"+e+"Container",s.showing)}this.updateThreads()}updateLandOptimized(){if(!t)return;this.updateElementText("landOptimized",Ie(t.land.optimizedLand/(t.land.baseLand*10)*100)+"%")}updateThreads(){if(!t)return;this.updateElementText("freeThreads",o(t.computer.freeThreads)),this.updateElementText("threads",o(t.computer.threads)),this.updateElementText("threadCost",o(t.computer.getThreadCost()));for(let e=0;e<t.computer.processes.length;e++){let s=t.computer.processes[e];if(!s)continue;let r="computerRow"+e+"Threads";if(s.showing&&this.elementExists(r))this.updateElementText(r,o(s.workers))}}updateSpeed(){if(!t)return;this.updateElementText("speed",o(t.computer.speed)),this.updateElementText("speedCost",o(t.computer.getSpeedCost()))}updateRowProgress(e){if(!t||!t.computer.unlocked)return;let s=t.computer.processes[e];if(!s||!s.showing)return;let r="computerRow"+e;if(!this.elementExists(r+"PB"))return;let i=this.getElement(r+"PB");i.style.width=s.currentTicks/s.ticksNeeded*100+"%",i.style.backgroundColor=s.isMoving?"yellow":"red",this.updateElementText(r+"CurrentTicks",o(s.currentTicks)),this.updateElementText(r+"TicksNeeded",o(s.ticksNeeded));let n=this.getElement(r+"CostContainer");if(s.cost!==0){n.classList.remove("hidden");let d=Array.isArray(s.cost)?s.cost[0]||0:s.cost,h=Array.isArray(s.costType)?s.costType[0]||"":s.costType;this.updateElementText(r+"Cost",o(d)),this.updateElementText(r+"CostType",h)}else n.classList.add("hidden")}addComputerRow(e){let s=this.getElement("computerRows"),r=document.createElement("div");r.className="computerRow";let i="computerRow"+e;r.id=i+"Container";let n=document.createElement("button");n.id=i+"Plus",n.innerHTML="+",n.addEventListener("click",(O)=>t?.computer.addThread(e,F(O)));let d=document.createElement("button");d.id=i+"Minus",d.innerHTML="-",d.addEventListener("click",(O)=>t?.computer.removeThread(e,F(O)));let h=document.createElement("div");h.id=i+"Threads",h.className="small",h.style.marginRight="4px";let m=t?.computer.processes[e]?.text||"",b=document.createElement("div");b.innerHTML=m;let S=document.createElement("div");S.className="rowProgressBarOuter",S.innerHTML="<div class='rowProgressBarInner' id='"+i+"PB'></div>";let f=document.createElement("div");f.className="computerTooltipContainer",f.id=i+"Tooltip";let x=document.createElement("div");x.className="rowTooltip";let R=t?.computer.processes[e]?.tooltip||"";x.innerHTML=`
            <div class="tooltipDescription">${R}</div>
            <div class="tooltipDivider"></div>
            <div class="tooltipStats">
                <div><b>Progress:</b> <span id="${i}CurrentTicks"></span> / <span id="${i}TicksNeeded"></span> ticks</div>
                <div id="${i}CostContainer" class="hidden"><b>Cost:</b> <span id="${i}Cost"></span> <span id="${i}CostType"></span> per tick</div>
            </div>
        `,f.appendChild(x),r.appendChild(n),r.appendChild(h),r.appendChild(d);let N=document.createElement("div");N.className="rowLabel",N.appendChild(b),r.appendChild(N),r.appendChild(S),r.appendChild(f),s.appendChild(r)}update(){}updateFull(){if(!t)return;if(this.checkUnlocked(),t.computer.unlocked)this.updateLandOptimized(),this.updateVisibility(),this.updateThreads(),this.updateSpeed()}}class ee extends l{rows=new Map;constructor(){super();if(t)c.on(t.events,"robots:unlocked",()=>this.checkUnlocked()),c.on(t.events,"robots:count:updated",()=>c.notifyOnlyOnce(()=>this.updateCount(),this.updateCount)),c.on(t.events,"robots:storage:updated",()=>c.notifyOnlyOnce(()=>this.updateStorage(),this.updateStorage)),c.on(t.events,"robots:mines:updated",()=>c.notifyOnlyOnce(()=>this.updateMinesCount(),this.updateMinesCount)),c.on(t.events,"robots:minesLimit:updated",()=>c.notifyOnlyOnce(()=>this.updateMinesLimit(),this.updateMinesLimit)),c.on(t.events,"energy:unlocked",()=>{if(t){let e=t.robots.jobs.find((s)=>s.text==="Turn ore into dirt");if(e)e.showing=!0}this.updateVisibility()})}checkUnlocked(){if(!t)return;if(this.updateElementText("unlockRobotsCost",o(I.UNLOCK_CASH_COST)),t.robots.unlocked)this.setVisible("unlockedRobots",!0),this.setVisible("unlockRobots",!1),this.setVisible("lightningContainer",!0),this.setVisible("lightningTooltip",!0),this.setVisible("energyContainer",!0),this.setVisible("woodContainer",!0),this.setVisible("oreContainer",!0),this.setVisible("metalContainer",!0),this.updateCount(),this.updateStorage(),this.updateMinesCount(),this.updateVisibility();else this.setVisible("unlockedRobots",!1),this.setVisible("unlockRobots",!0),this.setVisible("lightningContainer",!1),this.setVisible("lightningTooltip",!1),this.setVisible("energyContainer",!1),this.setVisible("woodContainer",!1),this.setVisible("oreContainer",!1),this.setVisible("metalContainer",!1)}updateVisibility(){if(!t)return;for(let e=0;e<t.robots.jobs.length;e++){let s=t.robots.jobs[e];if(!s)continue;this.setVisible("robotRow"+e+"Container",s.showing)}this.updateCount()}updateCount(){if(!t)return;if(this.updateElementText("robots",o(t.robots.robots)),this.updateElementText("robotsFree",o(t.robots.robotsFree)),t.robots.jobs[2]&&this.elementExists("minesLimit"))this.updateElementText("minesLimit",o(t.robots.minesLimit));if(t.robots.jobs[5]&&this.elementExists("totalDirtFromOre"))this.updateElementText("totalDirtFromOre",o(t.robots.jobs[5].completions*5));for(let s=0;s<t.robots.jobs.length;s++){let r=t.robots.jobs[s];if(!r)continue;let i="robotRow"+s;if(r.showing&&this.elementExists(i+"Workers"))this.updateElementText(i+"Workers",o(r.workers))}}updateMinesCount(){if(!t)return;if(this.elementExists("minesCount"))this.updateElementText("minesCount",o(t.robots.mines))}updateMinesLimit(){if(!t)return;if(this.elementExists("minesLimit"))this.updateElementText("minesLimit",o(t.robots.minesLimit))}updateStorage(){if(!t)return;this.updateElementText("robotMax",o(t.robots.robotMax))}updateRowProgress(e){if(!t)return;let s=t.robots.jobs[e];if(!s||!s.showing||s.ticksNeeded===0)return;let r="robotRow"+e;if(!this.elementExists(r+"PB"))return;let i=this.getElement(r+"PB");i.style.width=s.currentTicks/s.ticksNeeded*100+"%",i.style.backgroundColor=s.isMoving?"yellow":"red",this.updateElementText(r+"CurrentTicks",o(s.currentTicks)),this.updateElementText(r+"TicksNeeded",o(s.ticksNeeded));let n=this.getElement(r+"CostContainer");if(s.cost&&s.costType){n.classList.remove("hidden");let d=Array.isArray(s.cost)?s.cost:[s.cost],h=Array.isArray(s.costType)?s.costType:[s.costType],m=o(d[0]||0)+" "+(h[0]||"");m+=d.length>1?" and "+o(d[1]||0)+" "+(h[1]||""):"",this.updateElementText(r+"Cost",m)}else n.classList.add("hidden")}addRobotRow(e){let s=this.getElement("robotRows"),r=document.createElement("div");r.className="robotRow";let i="robotRow"+e;r.id=i+"Container";let n=document.createElement("button");n.id=i+"Plus",n.innerHTML="+",n.addEventListener("click",(M)=>t?.robots.addWorker(e,F(M)));let d=document.createElement("button");d.id=i+"Minus",d.innerHTML="-",d.addEventListener("click",(M)=>t?.robots.removeWorker(e,F(M)));let h=document.createElement("div");h.id=i+"Workers",h.className="small",h.style.marginRight="4px";let m=t?.robots.jobs[e]?.text||"",b=document.createElement("div");b.id=i+"Text",b.innerHTML=m;let S=document.createElement("div");if(t?.robots.jobs[e]?.ticksNeeded)S.className="rowProgressBarOuter",S.innerHTML="<div class='rowProgressBarInner' id='"+i+"PB'></div>";let f=document.createElement("div");f.className="computerTooltipContainer",f.id=i+"Tooltip";let x=document.createElement("div");x.className="rowTooltip";let R=t?.robots.jobs[e]?.tooltip||"",N="";if(t?.robots.jobs[e]?.ticksNeeded)N=`
                <div class="tooltipDivider"></div>
                <div class="tooltipStats">
                    <div><b>Progress:</b> <span id="${i}CurrentTicks"></span> / <span id="${i}TicksNeeded"></span> ticks</div>
                    <div id="${i}CostContainer" class="hidden"><b>Cost:</b> <span id="${i}Cost"></span> per tick</div>
                </div>
            `;x.innerHTML=`
            <div class="tooltipDescription" id="${i}Description">${R}</div>
            ${N}
        `,f.appendChild(x),r.appendChild(n),r.appendChild(h),r.appendChild(d);let O=document.createElement("div");if(O.className="rowLabel",O.appendChild(b),r.appendChild(O),S.innerHTML)r.appendChild(S);r.appendChild(f),s.appendChild(r)}update(){}updateFull(){if(!t)return;if(this.checkUnlocked(),t.robots.unlocked)this.updateCount(),this.updateStorage(),this.updateMinesCount(),this.updateVisibility()}}class te extends l{constructor(){super();if(t){let e=()=>c.notifyOnlyOnce(()=>this.update(),this);c.on(t.events,"ice:updated",e),c.on(t.events,"water:updated",e),c.on(t.events,"clouds:updated",e),c.on(t.events,"land:updated",e),c.on(t.events,"trees:updated",e),c.on(t.events,"farms:updated",e),c.on(t.events,"population:updated",e),c.on(t.events,"energy:updated",e),c.on(t.events,"resources:updated",e)}}update(){if(!t)return;this.updateElementText("totalWater",o(t.ice.ice+t.water.indoor+t.water.outdoor+t.clouds.water+t.land.water+t.trees.water+t.farms.water)),this.updateElementText("waterIncome",o(t.spaceStation.waterIncome,4)),this.updateElementText("waterBought",o(t.ice.buyIncome,4)),this.updateElementText("waterSpending",o(t.water.waterSpending,4)),this.updateElementText("waterFarms",o(t.farms.waterSpending,4)),this.updateElementText("waterTrees",o(t.trees.waterSpending,4)),this.updateElementText("waterNet",g(t.spaceStation.waterIncome+t.ice.buyIncome-t.water.waterSpending-t.farms.waterSpending-t.trees.waterSpending,4)),this.updateElementText("cash",o(t.cash)),this.updateElementText("cashIncome",o(t.population.cashDelta+t.water.gain,4)),this.updateElementText("cashFromPeople",o(t.population.cashDelta,4)),this.updateElementText("cashFromWater",o(t.water.gain,4)),this.updateElementText("cashComputer",o(t.computer.cashSpending,4)),this.updateElementText("cashNet",g(t.population.cashDelta+t.water.gain-t.computer.cashSpending,4)),this.updateElementText("oxygen",o(t.oxygen)),this.updateElementText("oxygenIncome",o(t.trees.oxygenGain,4)),this.updateElementText("oxygenLeak",o(t.oxygenLeak,4)),this.updateElementText("oxygenSmelting",o(t.robots.oxygenSpending,4)),this.updateElementText("oxygenNet",g(t.trees.oxygenGain-t.oxygenLeak-t.robots.oxygenSpending,4)),this.updateElementText("science",o(t.science)),this.updateElementText("scienceIncome",o(t.population.scienceDelta,4)),this.updateElementText("scienceComputer",o(t.computer.scienceSpending,4)),this.updateElementText("scienceNet",g(t.population.scienceDelta-t.computer.scienceSpending,4)),this.updateElementText("wood",o(t.wood)),this.updateElementText("woodIncome",o(t.robots.woodIncome,4)),this.updateElementText("woodSpending",o(t.robots.woodSpending,4)),this.updateElementText("woodComputer",o(t.computer.woodSpending,4)),this.updateElementText("woodNet",g(t.robots.woodIncome-t.robots.woodSpending-t.computer.woodSpending,4)),this.updateElementText("metal",o(t.metal)),this.updateElementText("metalIncome",o(t.robots.metalIncome,4)),this.updateElementText("metalSpending",o(t.robots.metalSpending,4)),this.updateElementText("metalComputer",o(t.computer.metalSpending,4)),this.updateElementText("metalNet",g(t.robots.metalIncome-t.robots.metalSpending-t.computer.metalSpending,4)),this.updateElementText("ore",o(t.ore,4)),this.updateElementText("oreIncome",o(t.robots.oreIncome,4)),this.updateElementText("oreSpending",o(t.robots.oreSpending,4)),this.updateElementText("oreToDirtSpending",o(t.robots.oreToDirtSpending,4)),this.updateElementText("oreNet",g(t.robots.oreIncome-t.robots.oreSpending-t.robots.oreToDirtSpending,4))}}class se extends l{constructor(){super();if(t)c.on(t.events,"water:maxIndoor:updated",()=>this.updateFull()),c.on(t.events,"ice:updated",()=>c.notifyOnlyOnce(()=>this.update(),this))}updateFull(){if(!t)return;this.updateElementText("indoorWaterMax",o(t.water.maxIndoor)),this.update()}update(){if(!t)return;this.updateElementText("ice",o(t.ice.ice)),this.updateElementText("buyableIce",o(t.ice.buyable)),this.updateElementText("iceTransferred",o(t.ice.transferred,4)),this.updateElementText("indoorWaterReceived",o(Math.max(0,t.ice.transferred-t.water.excess),4)),this.updateElementText("iceBuyerAmount",o(t.ice.gain)),this.updateElementText("indoorWater",o(t.water.indoor)),this.updateElementText("indoorWaterSelling",o(t.water.selling)),this.updateElementText("indoorWaterProfits",o(t.water.gain)),this.updateElementText("excessWater",o(t.water.excess,4))}}class re extends l{constructor(){super();if(t)c.on(t.events,"clouds:updated",()=>c.notifyOnlyOnce(()=>this.update(),this))}update(){if(!t)return;this.updateElementText("clouds",o(t.clouds.water)),this.updateElementText("stormTimer",o(t.clouds.stormTimer)),this.updateElementText("stormRate",t.clouds.stormRate+"%"),this.getElement("intensityPB").style.height=t.clouds.stormRate+"%",this.updateElementText("stormDuration",o(t.clouds.stormDuration)),this.updateElementText("rain",o(t.clouds.transferred,4)),this.updateElementText("landReceived",o(t.clouds.transferred,4)),this.updateElementText("lightningChance",o(t.clouds.lightningChance)+"%"),this.getElement("lightningPB").style.height=t.clouds.lightningChance+"%",this.updateElementText("lightningStrength",o(t.clouds.lightningStrength))}}class oe extends l{constructor(){super();if(t)c.on(t.events,"land:updated",()=>c.notifyOnlyOnce(()=>this.update(),this))}update(){if(!t)return;this.updateElementText("outdoorWater",o(t.water.outdoor)),this.updateElementText("lakeWaterFromStorage",o(t.water.excess,4)),this.updateElementText("waterTransferred",o(t.water.transferred,4)),this.updateElementText("cloudsReceived",o(t.water.transferred,4)),this.updateElementText("landWater",o(t.land.water)),this.updateElementText("optimizedLand",o(t.land.optimizedLand)),this.updateElementText("baseLand",o(t.land.baseLand)),this.updateElementText("land",o(t.land.land)),this.updateElementText("soil",o(t.land.soil)),this.updateElementText("landConverted",o(t.land.convertedLand,4)),this.updateElementText("landWaterToForest",o(t.land.transferred,4)),this.updateElementText("forestReceived",o(t.land.transferred,4)),this.updateElementText("landWaterToFarm",o(t.land.transferred,4)),this.updateElementText("farmReceived",o(t.land.transferred,4)),this.updateElementText("farmsWater",o(t.farms.water)),this.updateElementText("food",o(t.farms.food)),this.updateElementText("foodCreated",o(t.farms.foodCreated,4)),this.updateElementText("farmFoodEaten",o(t.population.foodEaten,4)),this.updateElementText("farmWaterToLake",o(t.farms.transferred,4)),this.updateElementText("lakeWaterFromFarm",o(t.farms.transferred,4)),this.updateElementText("farms",o(t.farms.farms)),this.updateElementText("efficiency",o(t.farms.efficiency*100)),this.updateElementText("farmRatioLabel",t.farms.farmRatio+"% soil to farms")}}class ie extends l{constructor(){super();if(t)c.on(t.events,"population:updated",()=>c.notifyOnlyOnce(()=>this.update(),this))}update(){if(!t)return;this.updateElementText("population",o(t.population.people)),this.updateElementText("foodEaten",o(t.population.foodEaten,4)),this.updateElementText("populationGrowth",g(t.population.popGrowth,4)),this.updateElementText("starving",o(t.population.starving,4)),this.updateElementText("scienceDelta",o(t.population.scienceDelta,4)),this.updateElementText("cashDelta",o(t.population.cashDelta,4)),this.updateElementText("scienceRatio",t.population.scienceRatio<50?100-t.population.scienceRatio+"% science":t.population.scienceRatio+"% cash"),this.updateElementText("happiness",o(t.population.happiness,4)),this.updateElementText("happinessFromHouse",o(t.population.houseBonus)),this.updateElementText("happinessFromTrees",o(t.population.happinessFromTrees,4)),this.updateElementText("happinessFromOxygen",o(t.population.happinessFromOxygen,4))}}class ne extends l{constructor(){super();if(t)c.on(t.events,"trees:updated",()=>c.notifyOnlyOnce(()=>this.update(),this))}update(){if(!t)return;this.updateElementText("forestWater",o(t.trees.water)),this.updateElementText("ferns",o(t.trees.ferns)),this.updateElementText("fernsDelta",o(t.trees.fernsDelta,4)),this.updateElementText("smallTrees",o(t.trees.smallTrees)),this.updateElementText("smallTreesDelta",o(t.trees.smallTreesDelta,4)),this.updateElementText("trees",o(t.trees.trees)),this.updateElementText("treesDelta",o(t.trees.treesDelta,4)),this.updateElementText("totalPlants",o(t.trees.totalPlants)),this.updateElementText("oxygenGain",o(t.trees.oxygenGain,4)),this.updateElementText("forestWaterToLake",o(t.trees.transferred,4)),this.updateElementText("lakeWaterFromForest",o(t.trees.transferred,4)),this.updateElementText("fernWater",o(t.trees.fernsWaterUse,4)),this.updateElementText("smallTreesWater",o(t.trees.smallTreesWaterUse,4)),this.updateElementText("treesWater",o(t.trees.treesWaterUse,4))}}class de extends l{constructor(){super();if(t)c.on(t.events,"energy:unlocked",()=>this.updateFull()),c.on(t.events,"energy:battery:updated",()=>this.updateFull()),c.on(t.events,"energy:updated",()=>c.notifyOnlyOnce(()=>this.update(),this)),this.setupAmountCostListener("buyBattery",[{spanId:"batteryOxygenCost",costPerUnit:T.BATTERY_OXYGEN_COST},{spanId:"batteryScienceCost",costPerUnit:T.BATTERY_SCIENCE_COST}])}checkUnlocked(){if(!t)return;if(this.updateElementText("unlockEnergyCost",o(T.UNLOCK_METAL_COST)),t.energy.unlocked){if(this.setVisible("unlockedEnergy",!0),this.setVisible("unlockEnergy",!1),this.getElement("spaceStationContainer").classList.contains("hidden"))this.getElement("spaceStationContainer").classList.remove("hidden")}else if(this.setVisible("unlockedEnergy",!1),this.setVisible("unlockEnergy",!0),!this.getElement("spaceStationContainer").classList.contains("hidden"))this.getElement("spaceStationContainer").classList.add("hidden")}update(){if(!t)return;this.updateElementText("energy",o(t.power)),this.updateElementText("energyProduction",o(t.energy.powerPerTick)),this.updateElementText("drain",o(t.energy.drain))}updateFull(){if(!t)return;if(this.checkUnlocked(),t.energy.unlocked){this.updateElementText("battery",o(t.energy.battery));let e=this.getAmount("buyBattery");this.updateCostSpans(e,[{spanId:"batteryOxygenCost",costPerUnit:T.BATTERY_OXYGEN_COST},{spanId:"batteryScienceCost",costPerUnit:T.BATTERY_SCIENCE_COST}])}this.update()}}class ue extends l{constructor(){super();if(t)c.on(t.events,"spaceStation:unlocked",()=>this.checkUnlocked()),c.on(t.events,"spaceStation:updated",()=>c.notifyOnlyOnce(()=>this.update(),this))}checkUnlocked(){if(!t)return;if(this.updateElementText("unlockSpaceStationMetalCost",o(L.UNLOCK_METAL_COST)),this.updateElementText("unlockSpaceStationWoodCost",o(L.UNLOCK_WOOD_COST)),t.spaceStation.unlocked)this.setVisible("spaceStationContainer",!0),this.setVisible("unlockedSpaceStation",!0),this.setVisible("unlockSpaceStation",!1),this.setVisible("tractorBeamContainer",!0);else this.setVisible("spaceStationContainer",!1),this.setVisible("unlockedSpaceStation",!1),this.setVisible("unlockSpaceStation",!0),this.setVisible("tractorBeamContainer",!1)}updateFull(){if(!t)return;if(this.checkUnlocked(),t.spaceStation.unlocked)this.update()}update(){if(!t)return;let e="",s="";for(let r=0;r<t.spaceStation.orbiting.length;r++){let i=t.spaceStation.orbiting[r];if(!i)continue;if(e+=o(i.amount)+" "+i.type,s+=o(i.amount/1e4,4)+" "+i.type,r!==t.spaceStation.orbiting.length-1)e+=", ",s+=", "}this.updateElementText("orbitingResources",e),this.updateElementText("orbitSending",s)}}class ce extends l{cometRows=new Map;takeAmountRows=new Map;constructor(){super();let e=document.getElementById("allPassing");if(e)e.innerHTML="";let s=document.getElementById("takeAmountContainer");if(s)s.innerHTML="";if(t)c.on(t.events,"tractorBeam:unlocked",()=>this.checkUnlocked()),c.on(t.events,"tractorBeam:updated",()=>c.notifyOnlyOnce(()=>this.update(),this)),c.on(t.events,"tractorBeam:removeComet",(r)=>{if(k)k.removeComet(r)})}checkUnlocked(){if(!t)return;if(this.updateElementText("unlockTractorBeamOxygenCost",o(_.UNLOCK_OXYGEN_REQ)),this.updateElementText("unlockTractorBeamScienceCost",o(_.UNLOCK_SCIENCE_COST)),t.tractorBeam.unlocked)this.setVisible("unlockedTractorBeam",!0),this.setVisible("unlockTractorBeam",!1);else this.setVisible("unlockedTractorBeam",!1),this.setVisible("unlockTractorBeam",!0)}updateFull(){if(!t)return;if(this.checkUnlocked(),t.tractorBeam.unlocked)this.update()}update(){if(!t||!k)return;let e=this.getElement("allPassing"),s=t.tractorBeam.comets,r=new Set(s.map((i)=>i.id));for(let[i,n]of this.cometRows.entries())if(!r.has(i))n.remove(),this.cometRows.delete(i);for(let i=0;i<s.length;i++){let n=s[i];if(!n)continue;if(!this.cometRows.has(n.id)){let d=document.createElement("div");d.className="comet-row",d.innerHTML=`<span>${n.name}</span> with <span id="comet-amount-${n.id}"></span> ${n.amountType} passing in <span id="comet-duration-${n.id}"></span>`,e.appendChild(d),this.cometRows.set(n.id,d)}this.updateElementText(`comet-amount-${n.id}`,o(n.amount)),this.updateElementText(`comet-duration-${n.id}`,o(n.duration)),k.drawComet(n)}this.updateTakeAmount()}updateTakeAmount(){if(!t)return;let e=this.getElement("takeAmountContainer"),r=t.tractorBeam.takeAmount.filter((d)=>d.amount>0),i=r.map((d)=>d.type).join(","),n=Array.from(this.takeAmountRows.keys()).join(",");if(i!==n){e.innerHTML="",this.takeAmountRows.clear();for(let d=0;d<r.length;d++){let h=r[d],m=document.createElement("span"),b=d===r.length-1;m.innerHTML=`<span id="takeAmountVal-${h.type}"></span> ${h.type}${b?"":", "}`,e.appendChild(m),this.takeAmountRows.set(h.type,m)}}for(let d of r)this.updateElementText(`takeAmountVal-${d.type}`,o(d.amount,3))}}class ae extends l{constructor(){super();if(t)c.on(t.events,"spaceDock:unlocked",()=>this.checkUnlocked()),c.on(t.events,"spaceDock:updated",()=>c.notifyOnlyOnce(()=>this.update(),this)),this.setupAmountCostListener("buyBattleshipAmount",[{spanId:"battleshipOxygenCost",costPerUnit:w.BATTLESHIP_OXYGEN_COST},{spanId:"battleshipScienceCost",costPerUnit:w.BATTLESHIP_SCIENCE_COST}])}checkUnlocked(){if(!t)return;if(t.spaceDock.unlocked)this.setVisible("spaceDockContainer",!0),this.setVisible("hangarContainer",!0),this.setVisible("spaceCanvas",!0),this.setVisible("spaceContainer",!0),this.update();else this.setVisible("spaceDockContainer",!1),this.setVisible("hangarContainer",!1),this.setVisible("spaceCanvas",!1),this.setVisible("spaceContainer",!1)}updateFull(){if(!t)return;if(this.checkUnlocked(),t.spaceDock.unlocked)this.update()}update(){if(!t)return;this.updateElementText("battleships",o(t.spaceDock.battleships)),this.updateElementText("totalBattleships",o(t.spaceDock.battleships+t.spaceDock.sended));let e=this.getAmount("buyBattleshipAmount");this.updateCostSpans(e,[{spanId:"battleshipOxygenCost",costPerUnit:w.BATTLESHIP_OXYGEN_COST},{spanId:"battleshipScienceCost",costPerUnit:w.BATTLESHIP_SCIENCE_COST}])}}class he extends l{constructor(){super();if(t){c.on(t.events,"hangar:updated",()=>c.notifyOnlyOnce(()=>this.updateFull(),this));let e=document.getElementById("maxMinesInput");if(e)e.addEventListener("change",(s)=>{if(t)t.hangar.maxMines=Number(s.target.value)});this.setupAmountCostListener("buyHangarAmount",[{spanId:"hangarCost",costPerUnit:v.METAL_COST_PER_RATE}])}}update(){if(!t)return;this.updateElementText("hangarSending",t.hangar.sendRate+" in "+Ae(t.hangar.timeRemaining/10)+" seconds.")}updateFull(){if(!t)return;if(this.getElement("hangarContainer").classList.contains("hidden"))return;let e=this.getAmount("buyHangarAmount");this.updateCostSpans(e,[{spanId:"hangarCost",costPerUnit:v.METAL_COST_PER_RATE}]);let s=document.getElementById("maxMinesInput");if(s)s.value=t.hangar.maxMines.toString();this.update()}}class me extends l{constructor(){super();if(t){c.on(t.events,"spaceDock:unlocked",()=>this.checkUnlocked()),c.on(t.events,"dysonSwarm:unlocked",()=>this.checkUnlocked()),c.on(t.events,"dysonSwarm:updated",()=>c.notifyOnlyOnce(()=>this.update(),this));let e=document.getElementById("unlockDysonSwarm");if(e)e.onclick=()=>{t?.dysonSwarm.unlockDysonSwarm()};let s=document.getElementById("btnBuySatellite");if(s)s.onclick=()=>{let r=document.getElementById("buySatelliteAmount"),i=parseInt(r.value)||0;t?.dysonSwarm.buySatellites(i)};this.setupAmountCostListener("buySatelliteAmount",[{spanId:"satMetalCost",costPerUnit:E.SATELLITE_METAL_COST},{spanId:"satScienceCost",costPerUnit:E.SATELLITE_SCIENCE_COST}])}}checkUnlocked(){if(!t)return;if(this.updateElementText("unlockDysonSwarmMetalCost",o(E.UNLOCK_METAL_COST)),this.updateElementText("unlockDysonSwarmScienceCost",o(E.UNLOCK_SCIENCE_COST)),t.spaceDock.unlocked)this.setVisible("dysonSwarmContainer",!0);else this.setVisible("dysonSwarmContainer",!1);if(t.dysonSwarm.unlocked)this.setVisible("unlockedDysonSwarm",!0),this.setVisible("unlockDysonSwarm",!1);else this.setVisible("unlockedDysonSwarm",!1),this.setVisible("unlockDysonSwarm",!0)}updateFull(){if(!t)return;if(this.checkUnlocked(),t.dysonSwarm.unlocked)this.update()}update(){if(!t)return;this.updateElementText("satellites",o(t.dysonSwarm.satellites)),this.updateElementText("dysonPower",o(t.dysonSwarm.getPowerProduction())+" / tick");let e=this.getAmount("buySatelliteAmount");this.updateCostSpans(e,[{spanId:"satMetalCost",costPerUnit:E.SATELLITE_METAL_COST},{spanId:"satScienceCost",costPerUnit:E.SATELLITE_SCIENCE_COST}])}}class fe extends l{progressBar1;progressBar2;computerView;robotsView;resourceView;iceView;cloudsView;landView;populationView;treesView;energyView;spaceStationView;tractorBeamView;spaceDockView;hangarView;dysonSwarmView;cometPool=[];allContainers=[];columns=[];lastVisibleCount=-1;lastWidth=-1;resizeHandler;constructor(){super();this.progressBar1=new U("nextStormProgress","#21276a"),this.progressBar2=new U("stormDurationProgress","#1c7682"),this.computerView=new z,this.robotsView=new ee,this.resourceView=new te,this.iceView=new se,this.cloudsView=new re,this.landView=new oe,this.populationView=new ie,this.treesView=new ne,this.energyView=new de,this.spaceStationView=new ue,this.tractorBeamView=new ce,this.spaceDockView=new ae,this.hangarView=new he,this.dysonSwarmView=new me;let e=this.getElement("mainContainer");e.querySelectorAll(".container").forEach((r)=>e.appendChild(r)),e.querySelectorAll(".column").forEach((r)=>r.remove()),this.allContainers=Array.from(e.querySelectorAll(".container"));let s=this.getElement("cometsContainer");if(s)s.innerHTML="";if(this.resizeHandler=()=>this.refreshLayout(),window.addEventListener("resize",this.resizeHandler),t)c.on(t.events,"tick",()=>this.update()),c.on(t.events,"computer:unlocked",()=>this.refreshLayout()),c.on(t.events,"robots:unlocked",()=>this.refreshLayout()),c.on(t.events,"energy:unlocked",()=>this.refreshLayout()),c.on(t.events,"spaceStation:unlocked",()=>this.refreshLayout()),c.on(t.events,"tractorBeam:unlocked",()=>this.refreshLayout()),c.on(t.events,"spaceDock:unlocked",()=>this.refreshLayout()),c.on(t.events,"dysonSwarm:unlocked",()=>this.refreshLayout())}destroy(){window.removeEventListener("resize",this.resizeHandler)}update(){if(!t)return;c.notifyOnlyOnce(()=>this.resourceView.update(),this.resourceView),c.notifyOnlyOnce(()=>this.iceView.update(),this.iceView),c.notifyOnlyOnce(()=>this.cloudsView.update(),this.cloudsView),c.notifyOnlyOnce(()=>this.landView.update(),this.landView),c.notifyOnlyOnce(()=>this.treesView.update(),this.treesView),c.notifyOnlyOnce(()=>this.populationView.update(),this.populationView),this.updateComputerRowProgress(),this.updateRobotsRowProgress(),c.notifyOnlyOnce(()=>this.energyView.update(),this.energyView),c.notifyOnlyOnce(()=>this.spaceStationView.update(),this.spaceStationView),c.notifyOnlyOnce(()=>this.tractorBeamView.update(),this.tractorBeamView),c.notifyOnlyOnce(()=>this.hangarView.update(),this.hangarView),c.notifyOnlyOnce(()=>this.dysonSwarmView.update(),this.dysonSwarmView),this.progressBar1.tick(t.clouds.initialStormTimer-t.clouds.stormTimer,t.clouds.initialStormTimer),this.progressBar2.tick(t.clouds.stormDuration,t.clouds.initialStormDuration),xe()}updateFull(){if(!t)return;this.resourceView.updateFull(),this.iceView.updateFull(),this.cloudsView.updateFull(),this.landView.updateFull(),this.treesView.updateFull(),this.populationView.updateFull(),this.computerView.updateFull(),this.robotsView.updateFull(),this.energyView.updateFull(),this.spaceStationView.updateFull(),this.tractorBeamView.updateFull(),this.spaceDockView.updateFull(),this.hangarView.updateFull(),this.dysonSwarmView.updateFull()}refreshLayout(){let e=this.getElement("mainContainer");if(e.offsetWidth===0)return;let s=window.getComputedStyle(e),r=parseFloat(s.columnGap||s.gap||"0"),i=280,n=e.querySelector(".column");if(n)i=parseFloat(window.getComputedStyle(n).minWidth);else{let f=document.createElement("div");f.className="column",f.style.visibility="hidden",f.style.position="absolute",e.appendChild(f),i=parseFloat(window.getComputedStyle(f).minWidth),e.removeChild(f)}i=Math.max(200,i||0);let d=i+r,h=e.offsetWidth,m=Math.max(1,Math.floor((h+r)/d)),b=this.allContainers.filter((f)=>!f.classList.contains("hidden")),S=b.length;if(this.columns.length===m&&S===this.lastVisibleCount&&h===this.lastWidth)return;b.sort((f,x)=>x.offsetHeight-f.offsetHeight);for(let f of this.allContainers)e.appendChild(f);if(this.columns.length!==m){this.columns.forEach((f)=>f.remove()),this.columns=[];for(let f=0;f<m;f++){let x=document.createElement("div");x.className="column",e.appendChild(x),this.columns.push(x)}}if(this.lastVisibleCount=S,this.lastWidth=h,this.columns.length===0)return;for(let f=0;f<b.length;f++){let x=b[f],R=this.columns[0],N=R.offsetHeight;for(let O=1;O<this.columns.length;O++){let M=this.columns[O];if(M.offsetHeight<N)R=M,N=M.offsetHeight}R.appendChild(x)}}clearComputerRows(){this.getElement("computerRows").innerHTML="",this.computerView.clearCache()}clearRobotRows(){this.getElement("robotRows").innerHTML="",this.robotsView.clearCache()}updateComputerRowProgress(){if(!t||!t.computer.unlocked)return;for(let e=0;e<t.computer.processes.length;e++)this.computerView.updateRowProgress(e)}updateRobotsRowProgress(){if(!t)return;for(let e=0;e<t.robots.jobs.length;e++)this.robotsView.updateRowProgress(e)}drawComet(e){let s,r="comet"+e.id;if(!e.drawed){if(s=this.cometPool.pop()||document.createElement("div"),s.className=e.name.toLowerCase(),s.id=r,s.classList.remove("hidden"),e.startingY===void 0){let i=q(e.speed,e.initialDuration,Math.random());e.startingY=i.startingY,e.endingX=i.endingX,e.slope=i.slope}this.getElement("cometsContainer").appendChild(s),e.drawed=!0}else s=document.getElementById(r);if(s){e.left=(e.initialDuration-e.duration)/e.initialDuration*e.endingX,e.top=e.slope*e.left+e.startingY;let i=e.amountType==="ice"?e.amount/1000:e.amount,d=(e.name==="Comet"?40:20)*Math.sqrt(i/200);s.style.width=Math.round(d)+"px",s.style.height=Math.round(d)+"px",s.style.borderRadius=Math.round(d/2)+"px",s.style.left=Math.round(e.left-d/2)+"px",s.style.top=Math.round(e.top-d/2)+"px"}}removeComet(e){let s="comet"+e.id,r=document.getElementById(s);if(r)r.classList.add("hidden"),r.id="",this.cometPool.push(r);else console.log(s+"not found")}}var He=()=>{let e=(n,d)=>{let h=document.getElementById(n);if(h)h.addEventListener("click",d)};e("btnHardReset",We),e("btnPause",Ce),e("btnBeg",Ke),e("btnSave",pe),e("btnExport",Ge),e("btnImport",Ue),e("btnBuyIce",()=>t?.buyIce()),e("unlockComputer",()=>t?.computer.unlockComputer()),e("buyThread",()=>t?.computer.buyThread()),e("buySpeed",()=>t?.computer.buySpeed()),e("unlockRobots",()=>t?.robots.unlockRobots()),e("unlockEnergy",()=>t?.energy.unlockEnergy()),e("btnBuyBattery",()=>t?.buyBattery()),e("unlockSpaceStation",()=>t?.spaceStation.unlockSpaceStation()),e("unlockTractorBeam",()=>t?.tractorBeam.unlockTractorBeam()),e("btnBuyBattleship",()=>t?.buyBattleship()),e("btnBuyHangar",()=>t?.buyHangar()),document.getElementById("mainContainer")?.addEventListener("contextmenu",(n)=>n.preventDefault()),document.getElementById("scienceSlider")?.addEventListener("input",function(){if(t)t.population.scienceRatio=Number(this.value)}),document.getElementById("farmSlider")?.addEventListener("input",function(){if(t)t.farms.farmRatio=Number(this.value)}),document.querySelectorAll(".numeric-input-small").forEach((n)=>{n.addEventListener("change",function(){let d=Number(this.value);if(isNaN(d)||d<1)this.value="1";else if(d!==Math.floor(d))this.value=Math.floor(d).toString()})})};if(document.readyState==="loading")document.addEventListener("DOMContentLoaded",He);else He();var le=[];function et(){if(le.length===0)return;let e=le[0]?.key;if(le.splice(0,1),e===66)t?.buyIce()}document.addEventListener("keydown",function(e){let s={key:e.charCode!==0?e.charCode:e.keyCode,shift:e.shiftKey};le.push(s),et()});class be{events=new Map;on(e,s){if(!this.events.has(e))this.events.set(e,[]);this.events.get(e)?.push(s)}off(e,s){let r=this.events.get(e);if(r)this.events.set(e,r.filter((i)=>i!==s))}emit(e,...s){let r=this.events.get(e);if(r)r.forEach((i)=>i(...s))}}var t=null,k=null,Ye=0,Oe=!1,Xe=0;function tt(){Ye++}function st(){Oe=!Oe}function Fe(){return Xe++,Xe}class Pe{totalLand;cash;oxygen;science;wood;metal;ore;power;oxygenLeak=0;canvasWidth=1200;canvasHeight=600;space;ice;water;clouds;land;trees;farms;population;computer;robots;energy;spaceStation;tractorBeam;spaceDock;hangar;dysonSwarm;events;constructor(){this.totalLand=1000,this.cash=100,this.oxygen=0,this.science=0,this.wood=0,this.metal=0,this.ore=0,this.power=0,this.canvasWidth=1200,this.canvasHeight=600,this.events=new be}tick(){this.water.waterSpending=0,this.water.gain=0,this.ice.tick(),this.robots.tick(),this.computer.tick(),this.land.soil-=this.farms.updateFarms(this.land.soil),this.farms.tick(this.land.transferWater()),this.population.tick(),this.water.outdoor+=this.farms.transferWater(),this.trees.tick(this.land.transferWater()),this.water.outdoor+=this.trees.transferWater(),this.land.tick(this.clouds.transferWater()),this.clouds.tick(this.water.transferWater()),this.energy.tick(),this.water.tick(this.ice.transferWater()),this.tractorBeam.tick(),this.spaceStation.tick(),this.dysonSwarm.tick(),this.space.tick(),this.oxygenLeak=this.oxygen/1e5,this.oxygen-=this.oxygenLeak,this.hangar.tick(),this.events.emit("resources:updated"),this.events.emit("tick")}initialize(){this.initializeSystems()}initializeSystems(){this.space=new Y,this.ice=new P,this.water=new V,this.clouds=new j,this.land=new $(this.totalLand),this.trees=new D,this.farms=new J,this.population=new Q,this.computer=new A,this.robots=new I,this.energy=new T,this.spaceStation=new L,this.tractorBeam=new _,this.spaceDock=new w,this.hangar=new v,this.dysonSwarm=new E,this.robots.updateMinesLimit()}initializeView(){k?.clearComputerRows();for(let e=0;e<this.computer.processes.length;e++){k?.computerView.addComputerRow(e);let s=this.computer.processes[e];if(s)s.isMoving=!1,s.completions=0}k?.clearRobotRows();for(let e=0;e<this.robots.jobs.length;e++){k?.robotsView.addRobotRow(e);let s=this.robots.jobs[e];if(s)s.completions=0}}buyIce(){let e=this.cash;if(e<=0)return;this.cash-=this.ice.buyIce(e)}buyBattery(){let e=document.getElementById("buyBattery"),s=Number(e.value);if(s*T.BATTERY_OXYGEN_COST>this.oxygen)s=Math.floor(this.oxygen/T.BATTERY_OXYGEN_COST);if(s*T.BATTERY_SCIENCE_COST>this.science)s=Math.floor(this.science/T.BATTERY_SCIENCE_COST);if(s<=0)return;this.oxygen-=s*T.BATTERY_OXYGEN_COST,this.science-=s*T.BATTERY_SCIENCE_COST,this.energy.buyBattery(s)}buyBattleship(){let e=document.getElementById("buyBattleshipAmount"),s=Number(e.value);if(s*w.BATTLESHIP_OXYGEN_COST>this.oxygen)s=Math.floor(this.oxygen/w.BATTLESHIP_OXYGEN_COST);if(s*w.BATTLESHIP_SCIENCE_COST>this.science)s=Math.floor(this.science/w.BATTLESHIP_SCIENCE_COST);if(s<=0)return;this.oxygen-=w.BATTLESHIP_OXYGEN_COST*s,this.science-=w.BATTLESHIP_SCIENCE_COST*s,this.spaceDock.addBattleship(s)}buyHangar(){let e=v.METAL_COST_PER_RATE,s=document.getElementById("buyHangarAmount"),r=Number(s.value);if(r*e>this.metal)r=Math.floor(this.metal/e);if(r<=0)return;this.metal-=r*e,this.hangar.sendRate+=r,this.events.emit("hangar:updated")}}function rt(){if(Oe)return;if(tt(),c.startBatch(),t?.tick(),c.endBatch(),Ye%100===0)pe()}function ot(e){Le.postMessage({stop:!0}),Le.postMessage({start:!0,ms:1000/e})}function Ce(){st()}var Le=new Worker(new URL("./workers/interval.js",import.meta.url).href);Le.onmessage=function(e){if(e.data==="interval.start")rt()};async function We(){window.localStorage.terrafold2="",await _e()}function it(){if(k)k.destroy();t=new Pe,t.initialize(),k=new fe,t.initializeView(),window.game=t,window.view=k}function nt(){if(!k)return;k.updateFull(),k.refreshLayout()}async function _e(){if(it(),window.localStorage.terrafold2){let e=await ke(window.localStorage.terrafold2),s=JSON.parse(e);if(t)ge(s,t);let r=document.getElementById("scienceSlider");if(r&&t)r.value=t.population.scienceRatio.toString();let i=document.getElementById("farmSlider");if(i&&t)i.value=t.farms.farmRatio.toString()}nt(),k?.refreshLayout(),ot(10)}var dt=["text","tooltip","events","canvasWidth","canvasHeight","drawed","isMoving","transferred","foodCreated","convertedLand","takeAmount","foodEaten","popGrowth","starving","scienceDelta","cashDelta","happinessFromTrees","happinessFromOxygen","happiness","fernsDelta","fernsWaterUse","smallTreesDelta","smallTreesWaterUse","treesDelta","treesWaterUse","totalPlants","oxygenGain","woodIncome","woodSpending","metalIncome","metalSpending","oreIncome","oreSpending","oreToDirtSpending","oxygenSpending","waterIncome","waterSpending","cashSpending","scienceSpending","waterFarms","waterTrees","buyIncome","minesLimit"];function ge(e,s){for(let r in e)if(Object.prototype.hasOwnProperty.call(e,r)&&!dt.includes(r)){if(typeof e[r]==="object"&&e[r]!==null){if(typeof s[r]>"u")s[r]=Array.isArray(e[r])?[]:{};ge(e[r],s[r])}else if(typeof e[r]!=="function")s[r]=e[r]}}async function pe(){let e={};if(t)ge(t,e);window.localStorage.terrafold2=await Ee(JSON.stringify(e))}async function Ge(){await pe();let e=document.getElementById("exportImportSave");if(e)e.value=await Ee(window.localStorage.terrafold2||""),e.select(),document.execCommand("copy"),e.value=""}async function Ue(){let e=document.getElementById("exportImportSave");if(e)window.localStorage.terrafold2=await ke(e.value),await _e()}function Ke(){if(t)t.cash+=0.1}_e();window.game=t;window.view=k;window.pauseGame=Ce;export{k as view,pe as save,Ce as pauseGame,Fe as incrementCometId,Ue as importSave,t as game,Ge as exportSave,We as clearSave,Ke as begForMoney};

//# debugId=CF08E41C18BAE8D964756E2164756E21
//# sourceMappingURL=main.js.map
